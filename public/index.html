<script>
  // 1) n8n 웹훅 URL – 지금 사용한 엔드포인트 그대로
  const WEBHOOK_URL = "https://external.co-workerhou.se/n8n/webhook/public-chatbot";

  const chatBody = document.getElementById("chatBody");
  const chatInput = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const sendLabel = document.getElementById("sendLabel");
  const sessionId = "sess_" + Math.random().toString(36).slice(2);

  function addMessage(text, role, meta) {
    const row = document.createElement("div");
    row.className = "row " + role;

    const bubble = document.createElement("div");
    bubble.className = "bubble " + role;

    bubble.textContent = text;

    // 선택: from(ai/fallback) 같이 메타 표시
    if (meta && meta.from) {
      const tag = document.createElement("div");
      tag.style.fontSize = "10px";
      tag.style.opacity = "0.7";
      tag.style.marginTop = "4px";
      tag.textContent = meta.from === "ai" ? "AI 답변" :
                        meta.from === "fallback" ? "안내 기본 답변" : meta.from;
      bubble.appendChild(document.createElement("br"));
      bubble.appendChild(tag);
    }

    row.appendChild(bubble);
    chatBody.appendChild(row);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function setLoading(b) {
    sendBtn.disabled = b;
    sendLabel.textContent = b ? "답변 생성 중..." : "전송";
  }

  async function sendMessage(text) {
    const trimmed = text.trim();
    if (!trimmed) return;

    addMessage(trimmed, "user");
    setLoading(true);

    try {
      const res = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: trimmed,
          sessionId
        }),
      });

      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }

      // ⬇️ n8n 이 보내는 응답: { answer: "...", from: "ai"|"fallback"|"none" }
      const data = await res.json();

      const answer =
        (data && data.answer) ||
        "답변을 불러오지 못했어요. 잠시 후 다시 시도해 주세요.";

      const from = data && data.from;

      addMessage(answer, "bot", { from });
    } catch (e) {
      console.error(e);
      addMessage(
        "네트워크 오류가 발생했어요. 다시 시도해 주세요.",
        "bot"
      );
    } finally {
      setLoading(false);
    }
  }

  // 초기 인사
  addMessage(
    "안녕하세요, 오늘의집 큐레이터 CS 챗봇입니다.\n" +
      "큐레이터 활동, 링크 발급, 정산, 계약 관련 궁금한 내용을 편하게 물어보세요 :)",
    "bot"
  );

  sendBtn.addEventListener("click", () => {
    const text = chatInput.value;
    chatInput.value = "";
    sendMessage(text);
  });

  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      const text = chatInput.value;
      chatInput.value = "";
      sendMessage(text);
    }
  });
</script>
